<!DOCTYPE html>
<script>
    // ‚ö†Ô∏è GANTI DENGAN URL DARI DEPLOYMENT APPS SCRIPT BARU ANDA (Langkah 2)
    const GITHUB_COMMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbz8vtIyu_Dobf95vnP323adhWWPnQDsGIzPvP5ShWVLpXlwPjTzzjau20SifGVMk_MU/exec"; 
    const JEDA_WAKTU = 0; // Detik

    // --- DAFTAR 20 SOAL LENGKAP --- (TETAP SAMA)
    const originalQuestions = [ /* ... */ ];
    // --- AKHIR DAFTAR 20 SOAL LENGKAP ---

    let questions = [...originalQuestions]; 
    let currentQuestionIndex = -1;
    let studentData = { name: '', class: '', answers: [], totalScore: 0, maxScore: 0 };
    let timerInterval;

    // ... (Fungsi shuffleArray, setErrorMessage, startTimer, renderQuestion, checkAnswer, nextQuestion tetap sama) ...

    function finishQuiz() {
        const contentArea = document.getElementById('quiz-content');
        const navigation = document.getElementById('quiz-navigation');
        const status = document.getElementById('status');
        
        // Tampilan Akhir
        contentArea.innerHTML = `
            <div class="text-center p-8 bg-green-50 rounded-lg border border-green-200">
                <h3 class="text-2xl font-bold text-green-700 mb-2">Ujian Selesai üéâ</h3>
                <p class="text-gray-600">Terima kasih, <b>${studentData.name}</b> (${studentData.class}).</p>
                <p class="mt-4 text-3xl font-extrabold text-gray-800">
                    Skor Akhir: <b>${studentData.totalScore}</b> / <b>${studentData.maxScore}</b>
                </p>
                <div id="submission-status" class="mt-6 text-indigo-500 font-medium">Sedang mengirim data...</div>
            </div>
        `;
        navigation.style.display = 'none';
        status.textContent = 'Selesai';
        // üö® Panggil fungsi pengiriman ke GitHub
        sendToGitHub(); 
    }

    // üîó FUNGSI BARU: Kirim data ke GitHub melalui Apps Script Proxy
    async function sendToGitHub() {
        const submissionStatus = document.getElementById('submission-status');
        submissionStatus.innerHTML = '<div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Sedang mengirim data ke GitHub...</span></div>';

        // üìù Format data sesuai kebutuhan rekap (dipisahkan TAB \t)
        // Raw_Answers di-stringy-kan dan di-escape untuk aman
        const rawAnswersEscaped = JSON.stringify(studentData.answers).replace(/"/g, '""');
        
        // Buat satu baris data (record)
        const record = [
            new Date().toLocaleString("id-ID"),
            studentData.name.replace(/\t|\n|\r/g, ' '), // Bersihkan dari karakter control
            studentData.class.replace(/\t|\n|\r/g, ' '), 
            studentData.totalScore,
            studentData.maxScore,
            rawAnswersEscaped 
        ].join('\t') + '\n'; // Gunakan TAB (\t) sebagai delimiter, tambah newline (\n)

        // Payload yang dikirim ke Apps Script
        const payload = {
            // Ini adalah baris data yang akan ditambahkan ke file di GitHub
            content: record, 
            // Kirim juga metadata siswa untuk pesan commit
            Nama_Lengkap: studentData.name, 
            Kelas: studentData.class,
            Score_PG: studentData.totalScore
        };
        
        try {
            const maxRetries = 3;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(GITHUB_COMMIT_ENDPOINT, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP Error Status: ${response.status} (${response.statusText})`);
                    }

                    const result = await response.json();

                    if (result.result === 'success') {
                        submissionStatus.innerHTML = `<span class="text-green-600 font-bold">‚úÖ Data berhasil terkirim dan tersimpan di GitHub (${FILE_PATH})!</span>`;
                        return; // Sukses
                    } else {
                        throw new Error(`Apps Script Error: ${result.message}`);
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        submissionStatus.innerHTML = `<span class="text-yellow-600">Gagal kirim ke GitHub. Mencoba lagi dalam ${delay / 1000} detik... (${i + 1}/${maxRetries})</span>`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        } catch (error) {
            console.error("Final Submission Error:", error);
            let detailMessage = error.message;

            submissionStatus.innerHTML = `<span class="text-red-600 font-bold">‚ùå Data GAGAL Terkirim ke GitHub.</span><br><span class="text-sm text-red-500">Detail: ${detailMessage}</span>`;
        }
    }

    // Panggil renderQuestion saat halaman dimuat
    window.onload = renderQuestion;
</script>
</body>
</html>
