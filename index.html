<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ujian Informatika - Soal Per Soal</title>
  <style>
    /* (CSS kamu tetap sama persis, saya tidak ubah) */
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>Ujian Informatika - Bab 1 & 2</h2>
    <div id="status"></div>
  </div>

  <div class="question-area" id="quiz-content"></div>
  <div id="timer-message"></div>

  <div class="navigation" id="quiz-navigation">
    <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>
      Mulai Ujian / Soal Berikutnya
    </button>
  </div>
</div>

<script>
  // üîó Ganti dengan URL Web App kamu (yang /exec)
  const GOOGLE_SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbyh_oFss6YD67mU_9EaUH-J14JSwaz4OdSv26wnWsqj0_bMOPZ7nHKHD93N69_cktZ2/exec";
  const JEDA_WAKTU = 10;

  const questions = [
    { type: 'mc', text: 'Metode pengujian reliabilitas data ...', options: ['meningkatkan akurasi data','mengurangi sampel penelitian','menjamin data bebas dari bias','membandingkan data dengan teori','menentukan konsistensi pengukuran'], answer: 4, score: 5 },
    { type: 'mc', text: 'Terkait potensi bias seleksi ...', options: ['memilih subjek secara acak','memilih subjek yang paling aktif secara sosial','menggunakan subjek yang paling mudah diakses','memilih subjek berdasarkan ketersediaan','memfokuskan pada subjek ekstrem'], answer: 0, score: 5 },
    { type: 'mc', text: 'Ketika menggunakan bahasa R ...', options: ['mengabaikan semua data','menggunakan mean','menggunakan interquartile range','mengumpulkan lebih banyak data','menganalisis variansi'], answer: 2, score: 5 },
    { type: 'mc', text: 'Pesan "Java tidak dikenal"...', options: ['instal ulang JDK','disable antivirus','instal web server','perbaiki path environment','instal Java'], answer: 3, score: 5 },
    { type: 'mc', text: 'Operator untuk membandingkan sama dengan ...', options: ['<','!=','>','==','!'], answer: 3, score: 5 },
    { type: 'essay', text: 'Jelaskan peran validitas eksternal dalam generalisasi data.', score: 10 }
  ];

  let currentQuestionIndex = -1;
  let studentData = { name: '', class: '', answers: [], totalScore: 0, passingScore: 0 };
  let timerInterval;

  function startTimer() {
    let timeLeft = JEDA_WAKTU;
    const timerMsg = document.getElementById('timer-message');
    const nextBtn = document.getElementById('next-btn');

    nextBtn.disabled = true;
    nextBtn.textContent = `Tunggu ${timeLeft} detik...`;
    timerMsg.textContent = `‚è≥ Soal berikutnya dalam ${timeLeft} detik...`;

    timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft > 0) {
        nextBtn.textContent = `Tunggu ${timeLeft} detik...`;
      } else {
        clearInterval(timerInterval);
        timerMsg.textContent = 'Silakan lanjut.';
        nextBtn.disabled = false;
        nextBtn.textContent = (currentQuestionIndex === questions.length - 1) ? 'Kirim Jawaban' : 'Soal Berikutnya';
      }
    }, 1000);
  }

  function renderQuestion() {
    const contentArea = document.getElementById('quiz-content');
    const status = document.getElementById('status');
    const nextBtn = document.getElementById('next-btn');

    if (currentQuestionIndex < 0) {
      contentArea.innerHTML = `
        <div class="required-error" id="data-error">Isi Nama & Kelas dulu.</div>
        <h3>Data Diri</h3>
        <label>Nama Lengkap:</label>
        <input type="text" id="student-name">
        <label>Kelas:</label>
        <select id="student-class">
          <option value="">-- Pilih Kelas --</option>
          <option value="X DKV 1">X DKV 1</option>
          <option value="X DKV 2">X DKV 2</option>
          <option value="X APHP">X APHP</option>
        </select>
      `;
      nextBtn.textContent = 'Mulai Ujian';
      nextBtn.disabled = false;
      status.textContent = 'Siap Memulai.';
      document.getElementById('timer-message').textContent = '';
      return;
    }

    if (currentQuestionIndex < questions.length) {
      const q = questions[currentQuestionIndex];
      status.textContent = `Soal ${currentQuestionIndex + 1} dari ${questions.length}`;
      let htmlContent = `<h4>${currentQuestionIndex + 1}. ${q.text} (${q.score} Poin)</h4>`;

      if (q.type === 'mc') {
        htmlContent += '<div class="options">';
        q.options.forEach((opt, i) => {
          const labelId = `q${currentQuestionIndex}-opt${i}`;
          const letter = String.fromCharCode(65 + i);
          htmlContent += `
            <label for="${labelId}">
              <input type="radio" name="q${currentQuestionIndex}" id="${labelId}" value="${i}">
              <span>${letter}. ${opt}</span>
            </label>
          `;
        });
        htmlContent += '</div>';
      } else if (q.type === 'essay') {
        htmlContent += `<textarea id="essay-answer" placeholder="Tulis jawaban..."></textarea>`;
      }

      contentArea.innerHTML = htmlContent;
      nextBtn.textContent = (currentQuestionIndex === questions.length - 1) ? 'Kirim Jawaban' : 'Soal Berikutnya';

      if (currentQuestionIndex > 0) startTimer();
      else {
        nextBtn.disabled = false;
        document.getElementById('timer-message').textContent = 'Selamat Mengerjakan!';
      }
    } else {
      finishQuiz();
    }
  }

  function checkAnswer() {
    const q = questions[currentQuestionIndex];
    let studentAnswer = null;
    let scoreEarned = 0;

    if (q.type === 'mc') {
      const selected = document.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
      if (!selected) return false;
      studentAnswer = parseInt(selected.value);
      scoreEarned = (studentAnswer === q.answer) ? q.score : 0;
      studentData.passingScore += q.score;
    } else if (q.type === 'essay') {
      const essayText = document.getElementById('essay-answer').value.trim();
      if (essayText === '') return false;
      studentAnswer = essayText;
      scoreEarned = q.score;
      studentData.passingScore += q.score;
    }

    studentData.answers.push({
      q_index: currentQuestionIndex,
      q_type: q.type,
      student_answer: studentAnswer,
      score_earned: scoreEarned
    });
    studentData.totalScore += scoreEarned;
    return true;
  }

  function nextQuestion() {
    if (currentQuestionIndex === -1) {
      const nameInput = document.getElementById('student-name').value.trim();
      const classSelect = document.getElementById('student-class').value;
      if (nameInput === '' || classSelect === '') {
        document.getElementById('data-error').style.display = 'block';
        return;
      }
      studentData.name = nameInput;
      studentData.class = classSelect;
      currentQuestionIndex++;
      renderQuestion();
      return;
    }

    if (checkAnswer()) {
      currentQuestionIndex++;
      renderQuestion();
    } else {
      alert('Harap jawab soal sebelum lanjut!');
    }
  }

  function finishQuiz() {
    const contentArea = document.getElementById('quiz-content');
    const navigation = document.getElementById('quiz-navigation');
    const status = document.getElementById('status');

    contentArea.innerHTML = `
      <h3>Ujian Selesai üéâ</h3>
      <p>Terima kasih, <b>${studentData.name}</b> (${studentData.class}).</p>
      <p>Skor Otomatis: <b>${studentData.totalScore}</b> dari <b>${studentData.passingScore - questions[questions.length-1].score}</b></p>
      <p>Nilai akhir menunggu koreksi esai.</p>
    `;
    navigation.style.display = 'none';
    status.textContent = 'Selesai';
    sendToGoogleSheet();
  }

  // üîó Kirim data ke Google Sheet
  function sendToGoogleSheet() {
    const payload = {
      timestamp: new Date().toLocaleString("id-ID"),
      Nama_Lengkap: studentData.name,
      Kelas: studentData.class,
      Score_PG: studentData.totalScore,
      Score_Max: studentData.passingScore,
      Raw_Answers: JSON.stringify(studentData.answers)
    };

    fetch(GOOGLE_SHEET_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(res => console.log("‚úÖ Data terkirim:", res))
    .catch(err => console.error("‚ùå Error:", err));
  }

  renderQuestion();
</script>
</body>
</html>
